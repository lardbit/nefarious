#####################################################
# DO NOT EDIT THIS FILE
#
# Create an .env file instead.
# See https://github.com/lardbit/nefarious#part-1
#####################################################
version: '2.4'

services:

  # nefarious base service (to be extended)
  nefarious-base:
    image: lardbit/nefarious

  # nefarious base app service (to be extended)
  nefarious-app-base:
    extends:
      service: nefarious-base
    ports:
      - "8000:80"
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: always
    environment:
      # https://github.com/kennethreitz/dj-database-url
      DATABASE_URL: "sqlite:////nefarious-db/db.sqlite3"
      REDIS_HOST: "redis"
      NEFARIOUS_USER: ${NEFARIOUS_USER:-admin}
      NEFARIOUS_PASS: ${NEFARIOUS_PASS:-admin}
      HOST_DOWNLOAD_PATH: ${HOST_DOWNLOAD_PATH:-/tmp/}
      CONFIG_PATH: /nefarious-db
      TRANSMISSION_USER: ${TRANSMISSION_USER-admin}  # to pre-populate settings (can be empty)
      TRANSMISSION_PASS: ${TRANSMISSION_PASS-admin}  # to pre-populate settings (can be empty)
    volumes:
      # persistent named volume for sqlite database
      - nefarious-db:/nefarious-db
    logging:
      options:
        max-size: 2m

  # celery base service (to be extended)
  celery-base:
    extends:
      service: nefarious-base
    restart: always
    entrypoint: /app/entrypoint-celery.sh
    volumes:
      - ${HOST_DOWNLOAD_PATH:-/tmp}:/downloads
      # persistent named volume for sqlite database
      - nefarious-db:/nefarious-db
    logging:
      options:
        max-size: 2m
    labels:
      - com.centurylinklabs.watchtower.enable=true

  # celery worker
  celery-worker:
    extends:
      service: celery-base
    environment:
      # https://github.com/kennethreitz/dj-database-url
      DATABASE_URL: "sqlite:////nefarious-db/db.sqlite3"
      REDIS_HOST: "redis"
      HOST_DOWNLOAD_PATH: ${HOST_DOWNLOAD_PATH:-/tmp}
      INTERNAL_DOWNLOAD_PATH: /downloads
      CELERY_BEAT_SEPARATELY: 1  # run worker and scheduler separately

  # celery scheduler (beat)
  celery-scheduler:
    extends:
      service: celery-base
    environment:
      # https://github.com/kennethreitz/dj-database-url
      DATABASE_URL: "sqlite:////nefarious-db/db.sqlite3"
      REDIS_HOST: "redis"
      HOST_DOWNLOAD_PATH: ${HOST_DOWNLOAD_PATH:-/tmp}
      INTERNAL_DOWNLOAD_PATH: /downloads
      CELERY_BEAT: 1  # run celery as scheduler
      CELERY_BEAT_SEPARATELY: 1  # run worker and scheduler separately

  # jackett base service (to be extended)
  jackett-base:
    labels:
      - com.centurylinklabs.watchtower.enable=true
    image: linuxserver/jackett
    mem_limit: 200m
    restart: always
    logging:
      options:
        max-size: 2m
    volumes:
      - jackett-config:/config

  # transmission base service (to be extended)
  transmission-base:
    labels:
      - com.centurylinklabs.watchtower.enable=true
    ports:
      - "9091:9091"
      - "51413:51413"  # peer port
    restart: always

  # auto update service (to be extended)
  # https://github.com/containrrr/watchtower
  watchtower-base:
    image: containrrr/watchtower
    restart: always
    command: --label-enable --cleanup
    environment:
      - WATCHTOWER_POLL_INTERVAL=3600
    logging:
      options:
        max-size: 2m
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  nefarious-db:
  jackett-config:
