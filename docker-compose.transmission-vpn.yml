#####################################################
# DO NOT EDIT THIS FILE
#
# Create an .env file instead.
# See https://github.com/lardbit/nefarious#part-1
#####################################################
version: '2.4'

services:

  nefarious:
    extends:
      file: docker-compose.base.yml
      service: nefarious-app-base

  celery:
    extends:
      file: docker-compose.base.yml
      service: celery-worker

  celery-scheduler:
    extends:
      file: docker-compose.base.yml
      service: celery-scheduler

  redis:
    extends:
      file: docker-compose.yml
      service: redis

  # torrent server
  transmission:
    extends:
      service: transmission-base
      file: docker-compose.base.yml
    image: haugene/transmission-openvpn:latest
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "9091:9091"
      - "9117:9117"  # jackett which shares this vpn network
      - "51413:51413"  # peer port
    dns: # bypass any dns issues by not using ISP's DNS
      - 1.1.1.1 # cloudflare dns primary
      - 1.0.0.1 # cloudflare dns secondary
    volumes:
      - ${HOST_DOWNLOAD_PATH:-/tmp}:/data
      - /etc/localtime:/etc/localtime:ro
      - transmission-config:/data/transmission-home
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=${VPN_IPV6_DISABLED:-1}  # 0=ipv6 enabled, 1=ipv6 disabled
    environment:
      # additional options may need to be specified based on your VPN provider
      - OPENVPN_PROVIDER=${OPENVPN_PROVIDER}
      - OPENVPN_USERNAME=${OPENVPN_USERNAME}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD}
      - OPENVPN_CONFIG=${OPENVPN_CONFIG}
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60 --pull-filter ignore ping
      - LOCAL_NETWORK=${LOCAL_NETWORK:-192.168.1.0/24},172.17.0.0/16
      - GLOBAL_APPLY_PERMISSIONS=true
      - CREATE_TUN_DEVICE=true
      - PUID=${HOST_DOWNLOAD_UID:-1000}
      - PGID=${HOST_DOWNLOAD_GID:-1000}
      - TRANSMISSION_RPC_USERNAME=${TRANSMISSION_USER-admin}
      - TRANSMISSION_RPC_PASSWORD=${TRANSMISSION_PASS-admin}
      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED=${TRANSMISSION_RPC_AUTHENTICATION_REQUIRED:-true}
    logging:
      driver: json-file
      options:
        max-size: 10m

  # torrent indexer service which gets routed through the transmission vpn
  jackett:
    extends:
      file: docker-compose.base.yml
      service: jackett-base
    network_mode: service:transmission  # use transmission/vpn network
    depends_on:
      - transmission

  watchtower:
    extends:
      file: docker-compose.yml
      service: watchtower

volumes:
  nefarious-db:
    driver: local
  jackett-config:
    driver: local
  transmission-config:
    driver: local
