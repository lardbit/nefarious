#####################################################
# DO NOT EDIT THIS FILE
#
# Create an .env file instead.
# See https://github.com/lardbit/nefarious#part-1
#####################################################
version: '2.4'

services:
  # tailscale
  tailscale:
    image: docker.beardedtek.com/beardedtek-com/tailscale:latest
    container_name: tailscale
    restart: unless-stopped
    privileged: true
    volumes:
      - ./varlib:/var/lib
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=${TAILSCALE_IPV6_DISABLED:-1}  # 0=ipv6 enabled, 1=ipv6 disabled
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=${TAILSCALE_IPV6_FORWARDING:-1}
    environment:
      TAILSCALE_AUTHKEY: ${TAILSCALE_AUTH_KEY}
      TAILSCALE_HOSTNAME: sidecar-nefyoung
      TAILSCALE_TAGS: ${TAILSCALE_TAGS}
      TAILSCALE_ADVERTISE_ROUTE: ${TAILSCALE_ADVERTISE_ROUTE}
      TAILSCALE_ENABLE: "true"

  nefarious:
    extends:
      file: docker-compose.base.yml
      service: nefarious-app-base
    networks:
      - ${TAILSCALE_NETWORK_NAME:-nefarious}

  celery:
    extends:
      file: docker-compose.base.yml
      service: celery-base
    networks:
      - ${TAILSCALE_NETWORK_NAME:-nefarious}

  redis:
    extends:
      file: docker-compose.yml
      service: redis
    networks:
      - ${TAILSCALE_NETWORK_NAME:-nefarious}

  # torrent server
  transmission:
    extends:
      service: transmission-base
      file: docker-compose.base.yml
    networks:
      ${TAILSCALE_NETWORK_NAME:-nefarious}:
          ipv4_address: ${TRANSMISSION_IP:-192.168.254.2}

  # torrent indexer service which gets routed through the transmission vpn
  jackett:
    extends:
      file: docker-compose.base.yml
      service: jackett-base
    networks:
      ${TAILSCALE_NETWORK_NAME:-nefarious}:
          ipv4_address: ${JACKETT_IP:-192.168.254.3}

  watchtower:
    extends:
      file: docker-compose.yml
      service: watchtower
      networks:
      - ${TAILSCALE_NETWORK_NAME:-nefarious}

volumes:
  nefarious-db:
    driver: local
  jackett-config:
    driver: local

networks:
  ${TAILSCALE_NETWORK_NAME:-nefarious}:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-192.168.254.0/24}
          gateway: ${GATEWAY:-192.168.254.254}