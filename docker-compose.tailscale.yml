#####################################################
# DO NOT EDIT THIS FILE
#
# Create an .env file instead.
# See https://github.com/lardbit/nefarious#part-1
#####################################################
version: '2.4'

services:
  nefarious:
    extends:
      file: docker-compose.base.yml
      service: nefarious-app-base
    networks:
      nefarious:
          ipv4_address: ${NEFARIOUS_IP:-192.168.252.1}

  celery:
    extends:
      file: docker-compose.base.yml
      service: celery-base
    depends_on:
      - nefarious
      - transmission
      - jackett
    networks:
      - nefarious

  redis:
    extends:
      file: docker-compose.yml
      service: redis
    depends_on:
      - nefarious
      - transmission
      - jackett
    networks:
      - nefarious

  # torrent server using docker.beardedtek.com/beardedtek-com/docker-transmission:latest
  transmission:
    extends:
      service: transmission
      file: docker-compose.yml
    image: docker.beardedtek.com/beardedtek-com/docker-transmission:latest
    volumes:
      - ./varlib:/var/lib
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=${TAILSCALE_IPV6_DISABLED:-1}  # 0=ipv6 enabled, 1=ipv6 disabled
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=${TAILSCALE_IPV6_FORWARDING:-1}
    environment:
      TAILSCALE_AUTHKEY: ${TAILSCALE_AUTH_KEY}
      TAILSCALE_HOSTNAME: sidecar-nefyoung
      TAILSCALE_TAGS: ${TAILSCALE_TAGS}
      TAILSCALE_ADVERTISE_ROUTE: ${TAILSCALE_ADVERTISE_ROUTE}
      TAILSCALE_ENABLE: "true"
    networks:
      nefarious:
          ipv4_address: ${TRANSMISSION_IP:-192.168.252.2}

  # torrent indexer service which gets routed through the transmission vpn
  jackett:
    extends:
      file: docker-compose.base.yml
      service: jackett-base
    networks:
      nefarious:
          ipv4_address: ${JACKETT_IP:-192.168.252.3}

  watchtower:
    extends:
      file: docker-compose.yml
      service: watchtower
    depends_on:
      - nefarious
      - transmission
      - jackett
    networks:
      - nefarious

networks:
  nefarious:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-192.168.252.0/24}
          gateway: ${GATEWAY:-192.168.252.254}